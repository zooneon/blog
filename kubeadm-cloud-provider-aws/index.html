<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.351cb4de4fb8fafa1978.css" id="gatsby-global-css">code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><meta name="generator" content="Gatsby 2.32.13"/><style data-styled="" data-styled-version="5.3.3">.iwJLgg{-webkit-text-decoration:none;text-decoration:none;color:rgba(0,0,0,0.8);}/*!sc*/
data-styled.g1[id="styled-link__StyledLink-sc-1pzq7s8-0"]{content:"iwJLgg,"}/*!sc*/
.eMJSpf{box-shadow:0 4px 12px 0 rgba(0,0,0,0.05);height:6rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}/*!sc*/
data-styled.g2[id="header__Container-sc-1hjyk8g-0"]{content:"eMJSpf,"}/*!sc*/
.jJfoNH{font-size:1.6rem;font-weight:800;-webkit-letter-spacing:0.1rem;-moz-letter-spacing:0.1rem;-ms-letter-spacing:0.1rem;letter-spacing:0.1rem;text-transform:uppercase;margin:0;}/*!sc*/
@media (max-width:36em){.jJfoNH{text-align:center;}}/*!sc*/
data-styled.g3[id="header__Title-sc-1hjyk8g-1"]{content:"jJfoNH,"}/*!sc*/
@font-face{font-family:system;font-style:normal;font-weight:300;src:local('.SFNSText-Light'),local('.HelveticaNeueDeskInterface-Light'),local('.LucidaGrandeUI'),local('Ubuntu Light'),local('Segoe UI Light'),local('Roboto-Light'),local('DroidSans'),local('Tahoma');}/*!sc*/
:root{font-size:10px;}/*!sc*/
body{font-family:'system';margin:0;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;color:rgba(0,0,0,0.8);min-height:100vh;position:relative;font-size:1.6rem;}/*!sc*/
h1,h2,h3,h4,h5,h6{font-family:sans-serif;}/*!sc*/
h2{font-size:2.5rem;}/*!sc*/
h3{font-size:2.4rem;}/*!sc*/
h4{font-size:1.6rem;}/*!sc*/
code{font-family:Menlo,Monaco,"Courier New",Courier,monospace;word-break:break-word;}/*!sc*/
pre code{word-break:normal;}/*!sc*/
:not(pre) > code[class*="language-"],pre[class*="language-text"]{background-color:transparent;color:inherit;font-size:medium;}/*!sc*/
data-styled.g4[id="sc-global-hvINus1"]{content:"sc-global-hvINus1,"}/*!sc*/
.doySxy{display:block;height:6rem;}/*!sc*/
data-styled.g5[id="layout__Footer-sc-wzore3-0"]{content:"doySxy,"}/*!sc*/
.hYEVc{width:60%;max-width:728px;margin:0 auto;}/*!sc*/
@media (max-width:48em){.hYEVc{width:80%;}}/*!sc*/
data-styled.g6[id="layout__Content-sc-wzore3-1"]{content:"hYEVc,"}/*!sc*/
.gOfPmA{margin-top:8rem;}/*!sc*/
.gOfPmA img{width:100%;}/*!sc*/
@media (max-width:36em){.gOfPmA{margin-top:4rem;}}/*!sc*/
.gOfPmA p{line-height:1.5;}/*!sc*/
.gOfPmA blockquote{margin-left:0.25rem;font-size:1.6rem;color:inherit;font-style:italic;border-left:0.2rem solid rgb(0,0,0);padding-left:1rem;margin:1rem 0;}/*!sc*/
.gOfPmA pre{margin-bottom:2rem;}/*!sc*/
.gOfPmA h3{line-height:1.13;}/*!sc*/
.gOfPmA h2,.gOfPmA h3,.gOfPmA h4,.gOfPmA h5,.gOfPmA h6{margin:2rem 0 2rem;}/*!sc*/
.gOfPmA hr{border:0;border-top:0.1rem solid #ccc;display:block;height:1rem;padding:0;}/*!sc*/
data-styled.g18[id="post-styles__Container-sc-uvw59-0"]{content:"gOfPmA,"}/*!sc*/
@media (max-width:48em){.drQYUS{text-align:center;}}/*!sc*/
data-styled.g19[id="post-styles__Header-sc-uvw59-1"]{content:"drQYUS,"}/*!sc*/
.cCkgzF{margin-bottom:1rem;font-size:3rem;}/*!sc*/
data-styled.g20[id="post-styles__Title-sc-uvw59-2"]{content:"cCkgzF,"}/*!sc*/
.gmHquH{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;list-style:none;padding:0px;}/*!sc*/
data-styled.g21[id="post-styles__LinkList-sc-uvw59-3"]{content:"gmHquH,"}/*!sc*/
.beCzyQ{margin:1rem 0 5rem;}/*!sc*/
.beCzyQ .social-icon{display:inline-block;margin:0 0.5rem;cursor:pointer;}/*!sc*/
data-styled.g22[id="share__Container-sc-1hk3kno-0"]{content:"beCzyQ,"}/*!sc*/
.jiUAsV{font-size:1.4rem;color:rgb(0,0,0);}/*!sc*/
data-styled.g23[id="share___StyledP-sc-1hk3kno-1"]{content:"jiUAsV,"}/*!sc*/
.jyOtij{color:rgba(0,0,0,0.8);}/*!sc*/
data-styled.g24[id="blog-post___StyledSub-sc-1cxuom3-0"]{content:"jyOtij,"}/*!sc*/
.gjclbs{margin:5rem 0;}/*!sc*/
data-styled.g25[id="blog-post___StyledDiv-sc-1cxuom3-1"]{content:"gjclbs,"}/*!sc*/
</style><title data-react-helmet="true">AWS에서 쿠버네티스 클러스터 구축하기</title><meta data-react-helmet="true" name="description" content="개요 AWS EC2를 이용하여 쿠버네티스 클러스터를 구축할 경우 해당 클러스터가 AWS 환경에서 동작하고 있음을 알게 하기 위해서는 별도의 작업이 필요하다. 이 작업을 통해 API를 이용하여 별도의 작업 없이 클러스터 상에서 AWS의 서비스(ELB…"/><meta data-react-helmet="true" property="og:title" content="AWS에서 쿠버네티스 클러스터 구축하기"/><meta data-react-helmet="true" property="og:description" content="개요 AWS EC2를 이용하여 쿠버네티스 클러스터를 구축할 경우 해당 클러스터가 AWS 환경에서 동작하고 있음을 알게 하기 위해서는 별도의 작업이 필요하다. 이 작업을 통해 API를 이용하여 별도의 작업 없이 클러스터 상에서 AWS의 서비스(ELB…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" property="og:url" content="https://blog.zooneon.dev"/><meta data-react-helmet="true" property="og:locale" content="ko_KR"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="zooneon"/><meta data-react-helmet="true" name="twitter:title" content="AWS에서 쿠버네티스 클러스터 구축하기"/><meta data-react-helmet="true" name="twitter:description" content="개요 AWS EC2를 이용하여 쿠버네티스 클러스터를 구축할 경우 해당 클러스터가 AWS 환경에서 동작하고 있음을 알게 하기 위해서는 별도의 작업이 필요하다. 이 작업을 통해 API를 이용하여 별도의 작업 없이 클러스터 상에서 AWS의 서비스(ELB…"/><link rel="preconnect dns-prefetch" href="https://www.googletagmanager.com"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="icon" href="/favicon-32x32.png?v=5fa6e614f0c84651b75fe27d99928ac0" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/webpack-runtime-7bf595cb4fa6a094be5a.js"/><link as="script" rel="preload" href="/framework-45f0bfe9f06e0e8da7d0.js"/><link as="script" rel="preload" href="/styles-bc72ca78f9bad9fb1f45.js"/><link as="script" rel="preload" href="/app-2c7963cebb708efe718f.js"/><link as="script" rel="preload" href="/d5d7a013bc6c1e2b6d7db819052c16d7efea5559-257226443b7dcc72fbb2.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-fe46313b564a949646ae.js"/><link as="fetch" rel="preload" href="/page-data/kubeadm-cloud-provider-aws/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3649515864.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/983108779.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><noscript>Sorry! This site requires JavaScript to be enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav class="header__Container-sc-1hjyk8g-0 eMJSpf"><a class="styled-link__StyledLink-sc-1pzq7s8-0 iwJLgg" href="/"><h1 class="header__Title-sc-1hjyk8g-1 jJfoNH">zooneon&#x27;s dev log</h1></a></nav><div class="layout__Content-sc-wzore3-1 hYEVc"><article class="post-styles__Container-sc-uvw59-0 gOfPmA"><header class="post-styles__Header-sc-uvw59-1 drQYUS"><h1 class="post-styles__Title-sc-uvw59-2 cCkgzF">AWS에서 쿠버네티스 클러스터 구축하기</h1><sub class="blog-post___StyledSub-sc-1cxuom3-0 jyOtij"><span>Posted on <!-- -->December 14, 2022</span><span>  -  </span><span>7 min read</span></sub></header><div class="blog-post___StyledDiv-sc-1cxuom3-1 gjclbs"><h3>개요</h3>
<p>AWS EC2를 이용하여 쿠버네티스 클러스터를 구축할 경우 해당 클러스터가 AWS 환경에서 동작하고 있음을 알게 하기 위해서는 별도의 작업이 필요하다.</p>
<p>이 작업을 통해 API를 이용하여 별도의 작업 없이 클러스터 상에서 AWS의 서비스(ELB, EBS 등등)을 이용할 수 있다.</p>
<p>테스트 환경은 다음과 같다.</p>
<ul>
<li>Kubernetes v1.21.1</li>
<li>Docker v20.10.21</li>
</ul>
<h3>EC2 hostname 설정</h3>
<p>AWS의 private DNS를 사용할 수 있도록 인스턴스의 hostname을 다음과 같이 변경한다.</p>
<p><code class="language-text">ip-xxx-xxx-xxx-xxx.&lt;region>.compute.internal</code></p>
<p>다음 명령을 이용하면 간편하게 설정할 수 있다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">sudo</span> hostnamectl set-hostname <span class="token punctuation">\</span>
<span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -s http://169.254.169.254/latest/meta-data/local-hostname<span class="token variable">)</span></span>

$ <span class="token function">hostname</span>
ip-10-0-3-xxx.ap-northeast-2.compute.internal</code></pre></div>
<h3>IAM 정책, 역할 생성해서 EC2 연결</h3>
<p>인스턴스가 AWS 서비스를 이용할 수 있도록 정책을 생성한 뒤, 역할을 만들어 인스턴스에 연결한다.</p>
<p>마스터 노드가 수행하는 일이 더 많으므로 더 많은 정책이 필요하다.</p>
<ul>
<li>
<p>master 노드</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token punctuation">{</span>
<span class="token string">"Version"</span><span class="token builtin class-name">:</span> <span class="token string">"2012-10-17"</span>,
<span class="token string">"Statement"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token string">"Effect"</span><span class="token builtin class-name">:</span> <span class="token string">"Allow"</span>,
    <span class="token string">"Action"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">"autoscaling:DescribeAutoScalingGroups"</span>,
      <span class="token string">"autoscaling:DescribeLaunchConfigurations"</span>,
      <span class="token string">"autoscaling:DescribeTags"</span>,
      <span class="token string">"ec2:DescribeInstances"</span>,
      <span class="token string">"ec2:DescribeRegions"</span>,
      <span class="token string">"ec2:DescribeRouteTables"</span>,
      <span class="token string">"ec2:DescribeSecurityGroups"</span>,
      <span class="token string">"ec2:DescribeSubnets"</span>,
      <span class="token string">"ec2:DescribeVolumes"</span>,
      <span class="token string">"ec2:CreateSecurityGroup"</span>,
      <span class="token string">"ec2:CreateTags"</span>,
      <span class="token string">"ec2:CreateVolume"</span>,
      <span class="token string">"ec2:ModifyInstanceAttribute"</span>,
      <span class="token string">"ec2:ModifyVolume"</span>,
      <span class="token string">"ec2:AttachVolume"</span>,
      <span class="token string">"ec2:AuthorizeSecurityGroupIngress"</span>,
      <span class="token string">"ec2:CreateRoute"</span>,
      <span class="token string">"ec2:DeleteRoute"</span>,
      <span class="token string">"ec2:DeleteSecurityGroup"</span>,
      <span class="token string">"ec2:DeleteVolume"</span>,
      <span class="token string">"ec2:DetachVolume"</span>,
      <span class="token string">"ec2:RevokeSecurityGroupIngress"</span>,
      <span class="token string">"ec2:DescribeVpcs"</span>,
      <span class="token string">"elasticloadbalancing:AddTags"</span>,
      <span class="token string">"elasticloadbalancing:AttachLoadBalancerToSubnets"</span>,
      <span class="token string">"elasticloadbalancing:ApplySecurityGroupsToLoadBalancer"</span>,
      <span class="token string">"elasticloadbalancing:CreateLoadBalancer"</span>,
      <span class="token string">"elasticloadbalancing:CreateLoadBalancerPolicy"</span>,
      <span class="token string">"elasticloadbalancing:CreateLoadBalancerListeners"</span>,
      <span class="token string">"elasticloadbalancing:ConfigureHealthCheck"</span>,
      <span class="token string">"elasticloadbalancing:DeleteLoadBalancer"</span>,
      <span class="token string">"elasticloadbalancing:DeleteLoadBalancerListeners"</span>,
      <span class="token string">"elasticloadbalancing:DescribeLoadBalancers"</span>,
      <span class="token string">"elasticloadbalancing:DescribeLoadBalancerAttributes"</span>,
      <span class="token string">"elasticloadbalancing:DetachLoadBalancerFromSubnets"</span>,
      <span class="token string">"elasticloadbalancing:DeregisterInstancesFromLoadBalancer"</span>,
      <span class="token string">"elasticloadbalancing:ModifyLoadBalancerAttributes"</span>,
      <span class="token string">"elasticloadbalancing:RegisterInstancesWithLoadBalancer"</span>,
      <span class="token string">"elasticloadbalancing:SetLoadBalancerPoliciesForBackendServer"</span>,
      <span class="token string">"elasticloadbalancing:AddTags"</span>,
      <span class="token string">"elasticloadbalancing:CreateListener"</span>,
      <span class="token string">"elasticloadbalancing:CreateTargetGroup"</span>,
      <span class="token string">"elasticloadbalancing:DeleteListener"</span>,
      <span class="token string">"elasticloadbalancing:DeleteTargetGroup"</span>,
      <span class="token string">"elasticloadbalancing:DescribeListeners"</span>,
      <span class="token string">"elasticloadbalancing:DescribeLoadBalancerPolicies"</span>,
      <span class="token string">"elasticloadbalancing:DescribeTargetGroups"</span>,
      <span class="token string">"elasticloadbalancing:DescribeTargetHealth"</span>,
      <span class="token string">"elasticloadbalancing:ModifyListener"</span>,
      <span class="token string">"elasticloadbalancing:ModifyTargetGroup"</span>,
      <span class="token string">"elasticloadbalancing:RegisterTargets"</span>,
      <span class="token string">"elasticloadbalancing:DeregisterTargets"</span>,
      <span class="token string">"elasticloadbalancing:SetLoadBalancerPoliciesOfListener"</span>,
      <span class="token string">"iam:CreateServiceLinkedRole"</span>,
      <span class="token string">"kms:DescribeKey"</span>
    <span class="token punctuation">]</span>,
    <span class="token string">"Resource"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">"*"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p>worker 노드</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token punctuation">{</span>
<span class="token string">"Version"</span><span class="token builtin class-name">:</span> <span class="token string">"2012-10-17"</span>,
<span class="token string">"Statement"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token string">"Effect"</span><span class="token builtin class-name">:</span> <span class="token string">"Allow"</span>,
    <span class="token string">"Action"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">"ec2:DescribeInstances"</span>,
      <span class="token string">"ec2:DescribeRegions"</span>,
      <span class="token string">"ecr:GetAuthorizationToken"</span>,
      <span class="token string">"ecr:BatchCheckLayerAvailability"</span>,
      <span class="token string">"ecr:GetDownloadUrlForLayer"</span>,
      <span class="token string">"ecr:GetRepositoryPolicy"</span>,
      <span class="token string">"ecr:DescribeRepositories"</span>,
      <span class="token string">"ecr:ListImages"</span>,
      <span class="token string">"ecr:BatchGetImage"</span>
    <span class="token punctuation">]</span>,
    <span class="token string">"Resource"</span><span class="token builtin class-name">:</span> <span class="token string">"*"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
</ul>
<p>역할을 생성했으면 인스턴스에 연결한다.</p>
<p><img src="https://user-images.githubusercontent.com/59433441/203196186-3c34cee4-0e07-4e36-ace1-9474ae234a78.png" alt="ec2-role"></p>
<h3>태그 등록</h3>
<p><code class="language-text">AWS Cloud Provider</code>가 인식할 수 있도록 해당 리소스에 다음과 같은 태그를 붙여야 한다.</p>
<p>태그를 붙이지 않으면 리소스를 인식하지 못하여 <code class="language-text">kubeadm init</code> 시에 오류가 발생한다.</p>
<p>먼저 태그에는 두 가지 속성이 있다.</p>
<ul>
<li><code class="language-text">kubernetes.io/cluster/&lt;your_cluster_id>: owned</code> : 리소스가 클러스터에 의해 소유되고 관리되는 경우</li>
<li><code class="language-text">kubernetes.io/cluster/&lt;your_cluster_id>: shared</code> : 리소스가 여러 클러스터 간에 공유되고, 클러스터가 삭제되어도 유지되어야 하는 경우</li>
</ul>
<p>아래 리소스에 해당하는 태그를 붙인다.</p>
<ul>
<li>
<p>Instance</p>
<ul>
<li><code class="language-text">kubernetes.io/cluster/&lt;your_cluster_id>: owned|shared</code></li>
</ul>
</li>
<li>
<p>Subnet</p>
<ul>
<li>Public Subnet : <code class="language-text">kubernetes.io/role/elb: 1</code></li>
<li>Private Subnet : <code class="language-text">kubernetes.io/role/internal-elb: 1</code></li>
<li>모든 Subnet : <code class="language-text">kubernetes.io/cluster/&lt;your_cluster_id>: owned|shared</code></li>
</ul>
</li>
<li>
<p>Routing Table</p>
<ul>
<li>Cloud Controller Manager가 <code class="language-text">--configure-cloud-routes: "false"</code> 옵션으로 시작되지 않는 경우 Subnet처럼 태그를 지정</li>
</ul>
</li>
<li>
<p>Security Group</p>
<ul>
<li><code class="language-text">kubernetes.io/cluster/&lt;your_cluster_id>: owned|shared</code></li>
</ul>
</li>
</ul>
<h3>Configuration 파일 적용</h3>
<p><code class="language-text">kubeadm</code>을 이용하여 클러스터를 구축하는 경우 configuration 파일에 <code class="language-text">cloud-provider</code> 옵션을 추가해야 한다.</p>
<p>3가지 경우에 맞게 configuration 파일을 적용한다.</p>
<ul>
<li>
<p>control plane 생성</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># control-plane.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterConfiguration
<span class="token key atrule">apiServer</span><span class="token punctuation">:</span>
<span class="token key atrule">extraArgs</span><span class="token punctuation">:</span>
  <span class="token key atrule">authorization-mode</span><span class="token punctuation">:</span> Node<span class="token punctuation">,</span>RBAC
  <span class="token key atrule">cloud-provider</span><span class="token punctuation">:</span> aws <span class="token comment"># cloud-provider 옵션 추가</span>
<span class="token key atrule">timeoutForControlPlane</span><span class="token punctuation">:</span> 4m0s
<span class="token key atrule">certificatesDir</span><span class="token punctuation">:</span> /etc/kubernetes/pki
<span class="token key atrule">clusterName</span><span class="token punctuation">:</span> &lt;cluster<span class="token punctuation">-</span>name<span class="token punctuation">></span> <span class="token comment"># 태그에 지정할 클러스터 이름을 명시</span>
<span class="token key atrule">controlPlaneEndpoint</span><span class="token punctuation">:</span> <span class="token string">'Endpoint:포트번호'</span> <span class="token comment"># HA 구성 시 &lt;LB Endpoint:포트번호></span>
<span class="token key atrule">controllerManager</span><span class="token punctuation">:</span>
<span class="token key atrule">extraArgs</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud-provider</span><span class="token punctuation">:</span> aws <span class="token comment"># cloud-provider 옵션 추가</span>
<span class="token key atrule">dns</span><span class="token punctuation">:</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> CoreDNS
<span class="token key atrule">etcd</span><span class="token punctuation">:</span>
<span class="token key atrule">local</span><span class="token punctuation">:</span>
  <span class="token key atrule">dataDir</span><span class="token punctuation">:</span> /var/lib/etcd
<span class="token key atrule">imageRepository</span><span class="token punctuation">:</span> k8s.gcr.io

<span class="token key atrule">networking</span><span class="token punctuation">:</span>
<span class="token key atrule">dnsDomain</span><span class="token punctuation">:</span> cluster.local
<span class="token key atrule">podSubnet</span><span class="token punctuation">:</span> 192.168.0.0/16
<span class="token key atrule">serviceSubnet</span><span class="token punctuation">:</span> 10.96.0.0/12
<span class="token key atrule">scheduler</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> InitConfiguration
<span class="token key atrule">nodeRegistration</span><span class="token punctuation">:</span>
<span class="token key atrule">kubeletExtraArgs</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud-provider</span><span class="token punctuation">:</span> aws <span class="token comment"># cloud-provider 옵션 추가</span></code></pre></div>
<p>아래와 같은 명령으로 configuration 파일을 적용한다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubeadm init --config control-plane.yaml</code></pre></div>
<p>만약 HA를 구성한다면 다음 명령을 사용한다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubeadm init --config control-plane.yaml --upload-certs</code></pre></div>
</li>
<li>
<p>HA를 위해 다수의 control plane을 이용</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># control-plane-join.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> JoinConfiguration
<span class="token key atrule">discovery</span><span class="token punctuation">:</span>
<span class="token key atrule">bootstrapToken</span><span class="token punctuation">:</span>
  <span class="token key atrule">token</span><span class="token punctuation">:</span> 123456.a4v4ii39rupz51j3 <span class="token comment"># token 값</span>
  <span class="token key atrule">apiServerEndpoint</span><span class="token punctuation">:</span> <span class="token string">'cp-lb.us-west-2.elb.amazonaws.com:6443'</span> <span class="token comment"># 엔드포인트로 사용할 LB는 미리 생성</span>
  <span class="token key atrule">caCertHashes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sha256:193feed98fb5fd2b4974...'</span><span class="token punctuation">]</span> <span class="token comment"># hash 값</span>
<span class="token key atrule">nodeRegistration</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> ip<span class="token punctuation">-</span>10<span class="token punctuation">-</span>0<span class="token punctuation">-</span>4<span class="token punctuation">-</span>xxx.ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>2.compute.internal <span class="token comment"># 등록할 control-plane hostname</span>
<span class="token key atrule">kubeletExtraArgs</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud-provider</span><span class="token punctuation">:</span> aws <span class="token comment"># cloud-provider 옵션 추가</span>
<span class="token key atrule">controlPlane</span><span class="token punctuation">:</span>
<span class="token key atrule">localAPIEndpoint</span><span class="token punctuation">:</span>
  <span class="token key atrule">advertiseAddress</span><span class="token punctuation">:</span> 10.0.4.xxx
<span class="token key atrule">certificateKey</span><span class="token punctuation">:</span> <span class="token string">'f6fcb672782d6f0581a106...'</span> <span class="token comment"># kubeadm init 이후 출력된 certificate key</span></code></pre></div>
<p>아래와 같은 명령으로 configuration 파일을 적용한다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubeadm <span class="token function">join</span> --config control-plane-join.yaml</code></pre></div>
</li>
<li>
<p>worker 노드 join</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># worker.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> JoinConfiguration
<span class="token key atrule">discovery</span><span class="token punctuation">:</span>
<span class="token key atrule">bootstrapToken</span><span class="token punctuation">:</span>
  <span class="token key atrule">token</span><span class="token punctuation">:</span> 123456.a4v4ii39rupz51j3 <span class="token comment"># token 값</span>
  <span class="token key atrule">apiServerEndpoint</span><span class="token punctuation">:</span> <span class="token string">'10.0.3.xxx:6443'</span> <span class="token comment"># HA가 구축되지 않은 경우, HA가 구축된 경우 LB 엔드포인트 사용</span>
  <span class="token key atrule">caCertHashes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> sha256<span class="token punctuation">:</span>193feed98fb5fd2b4974<span class="token punctuation">...</span> <span class="token comment"># hash 값</span>
<span class="token key atrule">nodeRegistration</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> ip<span class="token punctuation">-</span>10<span class="token punctuation">-</span>0<span class="token punctuation">-</span>3<span class="token punctuation">-</span>xxx.ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>2.compute.internal <span class="token comment"># worker hostname</span>
<span class="token key atrule">kubeletExtraArgs</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud-provider</span><span class="token punctuation">:</span> aws <span class="token comment"># cloud-provider 옵션 추가</span></code></pre></div>
<p>아래와 같은 명령으로 configuration 파일을 적용한다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubeadm <span class="token function">join</span> --config worker.yaml</code></pre></div>
</li>
</ul>
<h3>AWS Controller Manager</h3>
<p>control plane을 init 했다면 <code class="language-text">AWS Controller Manager</code> 매니페스트 파일을 실행해야 한다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># kustomize 설치</span>
$ <span class="token function">wget</span> https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv4.5.6/kustomize_v4.5.6_linux_amd64.tar.gz
$ <span class="token function">gzip</span> -d kustomize_v4.5.6_linux_amd64.tar.gz
$ <span class="token function">tar</span> xvf kustomize_v4.5.6_linux_amd64.tar
$ <span class="token function">mv</span> ./kustomize  /usr/bin

<span class="token comment"># 매니페스트 파일 설치</span>
$ kustomize build <span class="token string">'github.com/kubernetes/cloud-provider-aws/examples/existing-cluster/overlays/superset-role/?ref=master'</span> <span class="token operator">|</span> kubectl apply -f -</code></pre></div>
<h3>CNI 플러그인 설치</h3>
<p>클러스터에서 사용할 CNI 플러그인을 설치한다.</p>
<p>테스트 환경에서는 Calico를 설치하였다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml</code></pre></div>
<h3>결과</h3>
<p>위 작업을 모두 완료하면 성공적으로 클러스터가 구축된 것을 확인할 수 있다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get nodes
NAME                                            STATUS   ROLES                  AGE    VERSION
ip-10-0-3-xxx.ap-northeast-2.compute.internal   Ready    control-plane,master   16m    v1.21.1
ip-10-0-3-xxx.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 13m    v1.21.1
ip-10-0-3-xxx.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 2m4s   v1.21.1</code></pre></div>
<h3>테스트</h3>
<p>AWS 서비스를 정상적으로 이용할 수 있는지 간단한 테스트를 진행하였다.</p>
<p>테스트용 Deployment와 Service를 배포한다.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># nginx-deploy.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deploy
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre></div>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># nginx-svc.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-type</span><span class="token punctuation">:</span> <span class="token string">'nlb'</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer</code></pre></div>
<p>정상적으로 AWS의 LB가 생성됨을 확인할 수 있다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get svc
NAME                                  TYPE           CLUSTER-IP       EXTERNAL-IP                                                                          PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
kubernetes                            ClusterIP      <span class="token number">10.96</span>.0.1        <span class="token operator">&lt;</span>none<span class="token operator">></span>                                                                               <span class="token number">443</span>/TCP        2d15h
nginx-service                         LoadBalancer   <span class="token number">10.108</span>.29.182    a9524dcbe2481446689a580b9face799-bbd01611be30a1f7.elb.ap-northeast-2.amazonaws.com   <span class="token number">80</span>:31905/TCP   114s</code></pre></div></div><ul class="post-styles__LinkList-sc-uvw59-3 gmHquH"><li><a rel="prev" class="styled-link__StyledLink-sc-1pzq7s8-0 iwJLgg" href="/k8s-calico-aws/">← <!-- -->쿠버네티스에서 Calico 사용하기 in AWS</a></li><li><a rel="next" class="styled-link__StyledLink-sc-1pzq7s8-0 iwJLgg" href="/ingress-nginx-413/">Ingress nginx 413 에러 해결하기<!-- --> →</a></li></ul><div class="comments-wrapper"><div>Loading script...</div><div></div></div><div class="share__Container-sc-1hk3kno-0 beCzyQ"><p class="share___StyledP-sc-1hk3kno-1 jiUAsV">Share if you liked it:</p></div></article></div><footer class="layout__Footer-sc-wzore3-0 doySxy"></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-PB788GF0S1"></script><script>
        
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
        </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/kubeadm-cloud-provider-aws/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-ed717a4fd71e6ab9d4db.js"],"app":["/app-2c7963cebb708efe718f.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-16703ee5599528db9f93.js"],"component---src-pages-404-js":["/component---src-pages-404-js-9ead8f60164dc266ad59.js"],"component---src-pages-index-js":["/component---src-pages-index-js-086e431eccd6716ccd77.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-fe46313b564a949646ae.js"]};/*]]>*/</script><script src="/polyfill-ed717a4fd71e6ab9d4db.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-fe46313b564a949646ae.js" async=""></script><script src="/d5d7a013bc6c1e2b6d7db819052c16d7efea5559-257226443b7dcc72fbb2.js" async=""></script><script src="/app-2c7963cebb708efe718f.js" async=""></script><script src="/styles-bc72ca78f9bad9fb1f45.js" async=""></script><script src="/framework-45f0bfe9f06e0e8da7d0.js" async=""></script><script src="/webpack-runtime-7bf595cb4fa6a094be5a.js" async=""></script></body></html>