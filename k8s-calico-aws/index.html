<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.351cb4de4fb8fafa1978.css" id="gatsby-global-css">code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><meta name="generator" content="Gatsby 2.32.13"/><style data-styled="" data-styled-version="5.3.3">.iwJLgg{-webkit-text-decoration:none;text-decoration:none;color:rgba(0,0,0,0.8);}/*!sc*/
data-styled.g1[id="styled-link__StyledLink-sc-1pzq7s8-0"]{content:"iwJLgg,"}/*!sc*/
.eMJSpf{box-shadow:0 4px 12px 0 rgba(0,0,0,0.05);height:6rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}/*!sc*/
data-styled.g2[id="header__Container-sc-1hjyk8g-0"]{content:"eMJSpf,"}/*!sc*/
.jJfoNH{font-size:1.6rem;font-weight:800;-webkit-letter-spacing:0.1rem;-moz-letter-spacing:0.1rem;-ms-letter-spacing:0.1rem;letter-spacing:0.1rem;text-transform:uppercase;margin:0;}/*!sc*/
@media (max-width:36em){.jJfoNH{text-align:center;}}/*!sc*/
data-styled.g3[id="header__Title-sc-1hjyk8g-1"]{content:"jJfoNH,"}/*!sc*/
@font-face{font-family:system;font-style:normal;font-weight:300;src:local('.SFNSText-Light'),local('.HelveticaNeueDeskInterface-Light'),local('.LucidaGrandeUI'),local('Ubuntu Light'),local('Segoe UI Light'),local('Roboto-Light'),local('DroidSans'),local('Tahoma');}/*!sc*/
:root{font-size:10px;}/*!sc*/
body{font-family:'system';margin:0;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;color:rgba(0,0,0,0.8);min-height:100vh;position:relative;font-size:1.6rem;}/*!sc*/
h1,h2,h3,h4,h5,h6{font-family:sans-serif;}/*!sc*/
h2{font-size:2.5rem;}/*!sc*/
h3{font-size:2.4rem;}/*!sc*/
h4{font-size:1.6rem;}/*!sc*/
code{font-family:Menlo,Monaco,"Courier New",Courier,monospace;word-break:break-word;}/*!sc*/
pre code{word-break:normal;}/*!sc*/
:not(pre) > code[class*="language-"],pre[class*="language-text"]{background-color:transparent;color:inherit;font-size:medium;}/*!sc*/
data-styled.g4[id="sc-global-hvINus1"]{content:"sc-global-hvINus1,"}/*!sc*/
.doySxy{display:block;height:6rem;}/*!sc*/
data-styled.g5[id="layout__Footer-sc-wzore3-0"]{content:"doySxy,"}/*!sc*/
.hYEVc{width:60%;max-width:728px;margin:0 auto;}/*!sc*/
@media (max-width:48em){.hYEVc{width:80%;}}/*!sc*/
data-styled.g6[id="layout__Content-sc-wzore3-1"]{content:"hYEVc,"}/*!sc*/
.gOfPmA{margin-top:8rem;}/*!sc*/
.gOfPmA img{width:100%;}/*!sc*/
@media (max-width:36em){.gOfPmA{margin-top:4rem;}}/*!sc*/
.gOfPmA p{line-height:1.5;}/*!sc*/
.gOfPmA blockquote{margin-left:0.25rem;font-size:1.6rem;color:inherit;font-style:italic;border-left:0.2rem solid rgb(0,0,0);padding-left:1rem;margin:1rem 0;}/*!sc*/
.gOfPmA pre{margin-bottom:2rem;}/*!sc*/
.gOfPmA h3{line-height:1.13;}/*!sc*/
.gOfPmA h2,.gOfPmA h3,.gOfPmA h4,.gOfPmA h5,.gOfPmA h6{margin:2rem 0 2rem;}/*!sc*/
.gOfPmA hr{border:0;border-top:0.1rem solid #ccc;display:block;height:1rem;padding:0;}/*!sc*/
data-styled.g18[id="post-styles__Container-sc-uvw59-0"]{content:"gOfPmA,"}/*!sc*/
@media (max-width:48em){.drQYUS{text-align:center;}}/*!sc*/
data-styled.g19[id="post-styles__Header-sc-uvw59-1"]{content:"drQYUS,"}/*!sc*/
.cCkgzF{margin-bottom:1rem;font-size:3rem;}/*!sc*/
data-styled.g20[id="post-styles__Title-sc-uvw59-2"]{content:"cCkgzF,"}/*!sc*/
.gmHquH{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;list-style:none;padding:0px;}/*!sc*/
data-styled.g21[id="post-styles__LinkList-sc-uvw59-3"]{content:"gmHquH,"}/*!sc*/
.beCzyQ{margin:1rem 0 5rem;}/*!sc*/
.beCzyQ .social-icon{display:inline-block;margin:0 0.5rem;cursor:pointer;}/*!sc*/
data-styled.g22[id="share__Container-sc-1hk3kno-0"]{content:"beCzyQ,"}/*!sc*/
.jiUAsV{font-size:1.4rem;color:rgb(0,0,0);}/*!sc*/
data-styled.g23[id="share___StyledP-sc-1hk3kno-1"]{content:"jiUAsV,"}/*!sc*/
.jyOtij{color:rgba(0,0,0,0.8);}/*!sc*/
data-styled.g24[id="blog-post___StyledSub-sc-1cxuom3-0"]{content:"jyOtij,"}/*!sc*/
.gjclbs{margin:5rem 0;}/*!sc*/
data-styled.g25[id="blog-post___StyledDiv-sc-1cxuom3-1"]{content:"gjclbs,"}/*!sc*/
</style><title data-react-helmet="true">쿠버네티스에서 Calico 사용하기 with AWS</title><meta data-react-helmet="true" name="description" content="AWS EC2를 이용하여 쿠버네티스 클러스터를 구축하고 CNI 플러그인으로 Calico를 사용하기 위해서는 몇 가지 설정이 필요하다. 먼저 테스트 환경은 다음과 같다. Kubernetes v1.21.1 Docker v20.10.21 Calico v…"/><meta data-react-helmet="true" property="og:title" content="쿠버네티스에서 Calico 사용하기 with AWS"/><meta data-react-helmet="true" property="og:description" content="AWS EC2를 이용하여 쿠버네티스 클러스터를 구축하고 CNI 플러그인으로 Calico를 사용하기 위해서는 몇 가지 설정이 필요하다. 먼저 테스트 환경은 다음과 같다. Kubernetes v1.21.1 Docker v20.10.21 Calico v…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" property="og:url" content="https://blog.zooneon.dev"/><meta data-react-helmet="true" property="og:locale" content="ko_KR"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="zooneon"/><meta data-react-helmet="true" name="twitter:title" content="쿠버네티스에서 Calico 사용하기 with AWS"/><meta data-react-helmet="true" name="twitter:description" content="AWS EC2를 이용하여 쿠버네티스 클러스터를 구축하고 CNI 플러그인으로 Calico를 사용하기 위해서는 몇 가지 설정이 필요하다. 먼저 테스트 환경은 다음과 같다. Kubernetes v1.21.1 Docker v20.10.21 Calico v…"/><link rel="preconnect dns-prefetch" href="https://www.googletagmanager.com"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="icon" href="/favicon-32x32.png?v=5fa6e614f0c84651b75fe27d99928ac0" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/webpack-runtime-302c830d723193e48eb2.js"/><link as="script" rel="preload" href="/framework-45f0bfe9f06e0e8da7d0.js"/><link as="script" rel="preload" href="/styles-bc72ca78f9bad9fb1f45.js"/><link as="script" rel="preload" href="/app-2c7963cebb708efe718f.js"/><link as="script" rel="preload" href="/d5d7a013bc6c1e2b6d7db819052c16d7efea5559-257226443b7dcc72fbb2.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-fe46313b564a949646ae.js"/><link as="fetch" rel="preload" href="/page-data/k8s-calico-aws/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3649515864.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/983108779.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><noscript>Sorry! This site requires JavaScript to be enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav class="header__Container-sc-1hjyk8g-0 eMJSpf"><a class="styled-link__StyledLink-sc-1pzq7s8-0 iwJLgg" href="/"><h1 class="header__Title-sc-1hjyk8g-1 jJfoNH">zooneon&#x27;s dev log</h1></a></nav><div class="layout__Content-sc-wzore3-1 hYEVc"><article class="post-styles__Container-sc-uvw59-0 gOfPmA"><header class="post-styles__Header-sc-uvw59-1 drQYUS"><h1 class="post-styles__Title-sc-uvw59-2 cCkgzF">쿠버네티스에서 Calico 사용하기 with AWS</h1><sub class="blog-post___StyledSub-sc-1cxuom3-0 jyOtij"><span>Posted on <!-- -->November 22, 2022</span><span>  -  </span><span>12 min read</span></sub></header><div class="blog-post___StyledDiv-sc-1cxuom3-1 gjclbs"><p>AWS EC2를 이용하여 쿠버네티스 클러스터를 구축하고 CNI 플러그인으로 Calico를 사용하기 위해서는 몇 가지 설정이 필요하다.</p>
<p>먼저 테스트 환경은 다음과 같다.</p>
<ul>
<li>Kubernetes v1.21.1</li>
<li>Docker v20.10.21</li>
<li>Calico v3.24.5</li>
</ul>
<h2>BGP Peering</h2>
<p>기본적으로 Calico는 호스트 간 라우팅 정보를 공유하기 위해 BGP 프로토콜을 사용한다.</p>
<p>Calico를 설치하게 되면 Calico의 <code class="language-text">BIRD</code> 컴포넌트에 의해 calico-node 간 <code class="language-text">BGP Peering</code>이 발생하게 되는데, 이를 위해 179번 포트를 허용해줘야 한다.</p>
<p>만약 179번 포트가 닫혀 있다면 BGP peering에 실패하게 되고 calico-node는 Unhealty 상태가 된다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get po -n kube-system
NAME                                       READY   STATUS    RESTARTS   AGE
calico-kube-controllers-846d7f49d8-mjhnw   <span class="token number">1</span>/1     Running   <span class="token number">1</span>          3d
calico-node-7jkbx                          <span class="token number">0</span>/1     Running   <span class="token number">7</span>          3d
<span class="token punctuation">..</span>.</code></pre></div>
<p>describe를 해보면 peering에 실패했다는 메세지를 볼 수 있다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl describe po calico-node-7jkbx -n kube-system
<span class="token punctuation">..</span>.
Events:
  Type     Reason          Age                  From     Message
  ----     ------          ----                 ----     -------
  Normal   Pulled          9m33s                kubelet  Container image <span class="token string">"docker.io/calico/node:v3.24.5"</span> already present on machine
  Normal   Created         9m33s                kubelet  Created container mount-bpffs
  Normal   Started         9m33s                kubelet  Started container mount-bpffs
  Warning  Unhealthy       4m20s                kubelet  Readiness probe failed: <span class="token number">2022</span>-11-21 01:46:49.282 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1063</span><span class="token punctuation">]</span> confd/health.go <span class="token number">180</span>: Number of node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> with BGP peering established <span class="token operator">=</span> <span class="token number">0</span>
calico/node is not ready: BIRD is not ready: BGP not established with <span class="token number">10.0</span>.3.142,10.0.3.78</code></pre></div>
<p>보안그룹에서 179번 포트를 허용해주면 BGP Peering에 성공하고 모든 calico-node는 READY 상태가 된다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get po -n kube-system
NAME                                       READY   STATUS    RESTARTS   AGE
calico-kube-controllers-846d7f49d8-mjhnw   <span class="token number">1</span>/1     Running   <span class="token number">1</span>          3d
calico-node-7jkbx                          <span class="token number">1</span>/1     Running   <span class="token number">7</span>          3d
calico-node-z9xbl                          <span class="token number">1</span>/1     Running   <span class="token number">1</span>          3d
calico-node-zcsbq                          <span class="token number">1</span>/1     Running   <span class="token number">1</span>          3d</code></pre></div>
<h3>다른 노드 간 파드 통신</h3>
<p>테스트를 위해 netshoot 컨테이너를 각 노드에서 실행하도록 하였다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get po -o wide
NAME                       READY   STATUS        RESTARTS   AGE   IP                NODE      NOMINATED NODE   READINESS GATES
netshoot1                  <span class="token number">1</span>/1     Running       <span class="token number">0</span>          5s    <span class="token number">192.168</span>.235.176   worker1   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
netshoot2                  <span class="token number">1</span>/1     Running       <span class="token number">0</span>          5s    <span class="token number">192.168</span>.189.175   worker2   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span></code></pre></div>
<p>아무런 설정 없이 통신할 경우 통신이 되지 않는다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl <span class="token builtin class-name">exec</span> -it netshoot1 -- <span class="token function">bash</span>
bash-5.2<span class="token comment"># ping -c 1 192.168.189.175</span>
PING <span class="token number">192.168</span>.189.175 <span class="token punctuation">(</span><span class="token number">192.168</span>.189.175<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
^C
--- <span class="token number">192.168</span>.189.175 <span class="token function">ping</span> statistics ---
<span class="token number">1</span> packets transmitted, <span class="token number">0</span> received, <span class="token number">100</span>% packet loss, <span class="token function">time</span> 0ms</code></pre></div>
<p>두 가지 방법을 이용하여 이를 해결할 수 있다.</p>
<h3>IP-in-IP 모드 사용</h3>
<p>Calico를 설치하면 default mode로 <code class="language-text">IP-in-IP</code> 모드를 사용한다.</p>
<p>IP-in-IP 모드는 IP를 또 다른 IP 안에 집어 넣는 캡슐화를 수행한 뒤 통신하는 방법을 말한다.</p>
<p>Calico는 IP-in-IP 모드를 사용하여 파드의 출발지, 목적지 IP를 <code class="language-text">Inner IP header</code>에 넣고 <code class="language-text">Outer IP header</code>에 노드의 출발지, 목적지 IP를 넣어 통신한다.</p>
<p>(캡슐화를 통해 패킷은 자신이 가상 네트워크가 아닌 물리 네트워크에 존재한다고 생각한다.)</p>
<p>하지만 기본적으로 AWS에서는 IP-in-IP 프로토콜을 허용하지 않는다.</p>
<p>따라서 Calico의 IP-in-IP 모드를 사용하기 위해서는 보안그룹에 사용자 지정 프로토콜을 추가해줘야 한다.</p>
<p><img src="https://user-images.githubusercontent.com/59433441/202974442-2232e954-202c-4463-96fa-c1a738b48b41.png" alt="calico-aws1"></p>
<p>다시 통신해보면 정상적으로 되는 것을 확인할 수 있다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl <span class="token builtin class-name">exec</span> -it netshoot1 -- <span class="token function">bash</span>
bash-5.2<span class="token comment"># ping -c 1 192.168.189.175</span>
PING <span class="token number">192.168</span>.189.175 <span class="token punctuation">(</span><span class="token number">192.168</span>.189.175<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.189.175: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">62</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.508</span> ms

--- <span class="token number">192.168</span>.189.175 <span class="token function">ping</span> statistics ---
<span class="token number">1</span> packets transmitted, <span class="token number">1</span> received, <span class="token number">0</span>% packet loss, <span class="token function">time</span> 0ms</code></pre></div>
<p>AWS는 왜 IP-in-IP 모드를 기본적으로 허용하지 않을까?</p>
<p>→ AWS는 사용자가 보안 그룹에서 허용한 포트 및 프로토콜 외의 통신은 모두 차단하고 있다. 보안을 위해 최소한의 규칙을 추가해서 사용하는 것이 좋은데, 이를 위해 애초에 모든 규칙을 막아 놓은 것 같다.</p>
<h3>Direct 모드 사용</h3>
<p>IP-in-IP 모드 대신 <code class="language-text">Direct</code> 모드를 사용하여 이를 해결할 수도 있다.</p>
<p>Direct 모드는 <code class="language-text">IP-in-IP</code> 모드와 달리 캡슐화를 진행하지 않고 파드에서 파드로 직접 보낸 것처럼 동작한다.</p>
<p>(호스트 네트워크를 라우팅 할 때 파드 IP가 그대로 노출된다.)</p>
<p>Direct 모드를 사용하기 위해서는 IP-in-IP 모드를 비활성화 해야 한다.</p>
<p>이를 위해 Calico의 ippool 설정을 변경한다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># calicoctl이 먼저 설치되어 있어야 한다.</span>
$ calicoctl get ippool default-ipv4-ippool -o yaml <span class="token operator">></span> calico-ippool.yaml</code></pre></div>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># calico-ippool.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> projectcalico.org/v3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IPPool
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">'2022-11-21T02:48:58Z'</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>ipv4<span class="token punctuation">-</span>ippool
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">'523311'</span>
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> e060c782<span class="token punctuation">-</span>2c8f<span class="token punctuation">-</span>4a05<span class="token punctuation">-</span>84ae<span class="token punctuation">-</span>2ca39b0c0038
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">blockSize</span><span class="token punctuation">:</span> <span class="token number">26</span>
  <span class="token key atrule">cidr</span><span class="token punctuation">:</span> 192.168.0.0/16
  <span class="token key atrule">ipipMode</span><span class="token punctuation">:</span> Never <span class="token comment"># Direct 모드를 사용하기 위해 Always > Never 변경</span>
  <span class="token key atrule">natOutgoing</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span> all()
  <span class="token key atrule">vxlanMode</span><span class="token punctuation">:</span> Never</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># apply 명령을 통해 변경된 설정을 적용한다.</span>
$ calicoctl apply -f calico-ippool.yaml
Successfully applied <span class="token number">1</span> <span class="token string">'IPPool'</span> resource<span class="token punctuation">(</span>s<span class="token punctuation">)</span></code></pre></div>
<p>하지만 모드를 변경한다고 해서 통신이 되지 않는다.</p>
<p>이는 AWS의 <code class="language-text">src/dst</code> IP 확인 기능 때문인데, 이 기능은 목적지의 IP가 호스트 네트워크의 IP가 아닌 경우 패킷을 차단하는 역할을 한다.</p>
<p>현재 호스트 네트워크와 파드 네트워크 IP가 다르므로 이를 해제해야 한다.</p>
<p>EC2에서 인스턴스를 클릭한 뒤 <code class="language-text">작업 > 네트워킹 > 소스/대상 확인 변경 > 소스/대상 확인 중지</code>를 체크하여 비활성화 하면 된다.</p>
<p><img src="https://user-images.githubusercontent.com/59433441/202974447-cb85516d-83c0-44f9-8a78-5bfb00b58058.png" alt="calico-aws2"></p>
<p>설정을 완료했다면 정상적으로 통신이 가능한 것을 확인할 수 있다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl <span class="token builtin class-name">exec</span> -it netshoot1 -- <span class="token function">bash</span>
bash-5.2<span class="token comment"># ping -c 1 192.168.189.175</span>
PING <span class="token number">192.168</span>.189.175 <span class="token punctuation">(</span><span class="token number">192.168</span>.189.175<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.189.175: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">62</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.508</span> ms

--- <span class="token number">192.168</span>.189.175 <span class="token function">ping</span> statistics ---
<span class="token number">1</span> packets transmitted, <span class="token number">1</span> received, <span class="token number">0</span>% packet loss, <span class="token function">time</span> 0ms</code></pre></div>
<p>위에서 언급한 것처럼 Direct 모드는 IP-in-IP 모드와 달리 캡슐화, 디캡슐화 오버헤드가 없기 때문에 성능상 이점이 있다는 장점이 있다.</p>
<p>참고로 Direct 모드를 사용하면 <code class="language-text">tunl0</code> 인터페이스를 이용한 overlay 네트워크를 사용하지 않고 직접 통신하기 때문에 호스트의 라우팅 테이블이 변경된다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># IP-in-IP 모드 사용하는 경우</span>
$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="token number">0.0</span>.0.0         <span class="token number">10.0</span>.3.1        <span class="token number">0.0</span>.0.0         UG    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">10.0</span>.0.2        <span class="token number">10.0</span>.3.1        <span class="token number">255.255</span>.255.255 UGH   <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">10.0</span>.3.0        <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">10.0</span>.3.1        <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.255 UH    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">172.17</span>.0.0      <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.0.0     U     <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> docker0
<span class="token number">192.168</span>.189.64  <span class="token number">10.0</span>.3.78       <span class="token number">255.255</span>.255.192 UG    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> tunl0
<span class="token number">192.168</span>.189.173 <span class="token number">10.0</span>.3.78       <span class="token number">255.255</span>.255.255 UGH   <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> tunl0
<span class="token number">192.168</span>.189.175 <span class="token number">10.0</span>.3.78       <span class="token number">255.255</span>.255.255 UGH   <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> tunl0
<span class="token number">192.168</span>.219.64  <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.192 U     <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> *
<span class="token number">192.168</span>.219.74  <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.255 UH    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> cali4d001776093
<span class="token number">192.168</span>.219.75  <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.255 UH    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> calif639aaac1eb
<span class="token number">192.168</span>.219.76  <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.255 UH    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> calia782baf2d95
<span class="token number">192.168</span>.235.128 <span class="token number">10.0</span>.3.142      <span class="token number">255.255</span>.255.192 UG    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> tunl0</code></pre></div>
<p>Direct 모드를 사용하는 경우의 라우팅 테이블을 보면 tunl0 인터페이스 대신 호스트의 ens5 인터페이스로 경로가 변경된 것을 확인할 수 있다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Direct 모드 사용하는 경우</span>
$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="token number">0.0</span>.0.0         <span class="token number">10.0</span>.3.1        <span class="token number">0.0</span>.0.0         UG    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">10.0</span>.0.2        <span class="token number">10.0</span>.3.1        <span class="token number">255.255</span>.255.255 UGH   <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">10.0</span>.3.0        <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">10.0</span>.3.1        <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.255 UH    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">172.17</span>.0.0      <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.0.0     U     <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> docker0
<span class="token number">192.168</span>.189.64  <span class="token number">10.0</span>.3.78       <span class="token number">255.255</span>.255.192 UG    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">192.168</span>.189.173 <span class="token number">10.0</span>.3.78       <span class="token number">255.255</span>.255.255 UGH   <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">192.168</span>.189.175 <span class="token number">10.0</span>.3.78       <span class="token number">255.255</span>.255.255 UGH   <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">192.168</span>.219.64  <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.192 U     <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> *
<span class="token number">192.168</span>.219.74  <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.255 UH    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> cali4d001776093
<span class="token number">192.168</span>.219.75  <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.255 UH    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> calif639aaac1eb
<span class="token number">192.168</span>.219.76  <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.255 UH    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> calia782baf2d95
<span class="token number">192.168</span>.235.128 <span class="token number">10.0</span>.3.142      <span class="token number">255.255</span>.255.192 UG    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> ens5</code></pre></div>
<p>만약 Direct 모드를 사용하면서 다른 서브넷에 존재하는 노드의 파드와는 어떻게 통신할까?</p>
<p>기본적으로 다른 서브넷에 존재하는 노드의 경우 호스트 네트워크에서 노드 IP를 알 수 없으므로 게이트웨이로 라우팅 한다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="token number">0.0</span>.0.0         <span class="token number">10.0</span>.3.1        <span class="token number">0.0</span>.0.0         UG    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">10.0</span>.0.2        <span class="token number">10.0</span>.3.1        <span class="token number">255.255</span>.255.255 UGH   <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">10.0</span>.3.0        <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">10.0</span>.3.1        <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.255 UH    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">172.17</span>.0.0      <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.0.0     U     <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> docker0
<span class="token comment"># 다른 서브넷에 존재하는 노드의 파드 경우 게이트웨이로 라우팅</span>
<span class="token number">192.168</span>.189.78  <span class="token number">10.0</span>.3.1        <span class="token number">255.255</span>.255.192 UG    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> ens5</code></pre></div>
<p>패킷이 게이트웨이에 도달하게 되면 게이트웨이는 패킷을 어디로 보내야할지 모르는 상황이 된다.</p>
<p>위에서 언급했던 것처럼 Direct 모드는 패킷에 파드 IP를 그대로 사용하는데, 게이트웨이는 해당 IP가 호스트 네트워크 IP가 아니기 때문이다.</p>
<p>이를 해결하기 위해 서브넷 간 통신에서만 IP-in-IP 기능을 활성화 할 수 있는 <code class="language-text">CrossSubnet</code> 기능을 이용하면 된다.</p>
<p><code class="language-text">CrossSubnet</code> 기능을 이용하면 서브넷 내에서는 Direct 모드를 사용하고, 서브넷 간 통신에서는 IP-in-IP 모드를 사용한다.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># calico-ippool.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> projectcalico.org/v3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IPPool
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">'2022-11-21T02:48:58Z'</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>ipv4<span class="token punctuation">-</span>ippool
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">'523311'</span>
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> e060c782<span class="token punctuation">-</span>2c8f<span class="token punctuation">-</span>4a05<span class="token punctuation">-</span>84ae<span class="token punctuation">-</span>2ca39b0c0038
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">blockSize</span><span class="token punctuation">:</span> <span class="token number">26</span>
  <span class="token key atrule">cidr</span><span class="token punctuation">:</span> 192.168.0.0/16
  <span class="token key atrule">ipipMode</span><span class="token punctuation">:</span> CrossSubnet <span class="token comment"># CrossSubnet 모드를 사용하기 위해 Never > CrossSubnet 변경</span>
  <span class="token key atrule">natOutgoing</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span> all()
  <span class="token key atrule">vxlanMode</span><span class="token punctuation">:</span> Never</code></pre></div>
<p>설정을 변경한 후 라우팅 테이블을 확인해 보면 해당 라우팅에 한해서 정보가 변경되었음을 확인할 수 있다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="token number">0.0</span>.0.0         <span class="token number">10.0</span>.3.1        <span class="token number">0.0</span>.0.0         UG    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">10.0</span>.0.2        <span class="token number">10.0</span>.3.1        <span class="token number">255.255</span>.255.255 UGH   <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">10.0</span>.3.0        <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">10.0</span>.3.1        <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.255 UH    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens5
<span class="token number">172.17</span>.0.0      <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.0.0     U     <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> docker0
<span class="token comment"># ens5 인터페이스가 아닌 tunl0 인터페이스로 변경</span>
<span class="token number">192.168</span>.189.78  <span class="token number">10.0</span>.3.78       <span class="token number">255.255</span>.255.192 UG    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> tunl0</code></pre></div></div><ul class="post-styles__LinkList-sc-uvw59-3 gmHquH"><li><a rel="prev" class="styled-link__StyledLink-sc-1pzq7s8-0 iwJLgg" href="/k8s-service/">← <!-- -->쿠버네티스 서비스</a></li><li><a rel="next" class="styled-link__StyledLink-sc-1pzq7s8-0 iwJLgg" href="/kubeadm-cloud-provider-aws/">AWS에서 쿠버네티스 클러스터 구축하기<!-- --> →</a></li></ul><div class="comments-wrapper"><div>Loading script...</div><div></div></div><div class="share__Container-sc-1hk3kno-0 beCzyQ"><p class="share___StyledP-sc-1hk3kno-1 jiUAsV">Share if you liked it:</p></div></article></div><footer class="layout__Footer-sc-wzore3-0 doySxy"></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-PB788GF0S1"></script><script>
        
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
        </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/k8s-calico-aws/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-ed717a4fd71e6ab9d4db.js"],"app":["/app-2c7963cebb708efe718f.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-16703ee5599528db9f93.js"],"component---src-pages-404-js":["/component---src-pages-404-js-9ead8f60164dc266ad59.js"],"component---src-pages-index-js":["/component---src-pages-index-js-911b6742c5b371483563.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-fe46313b564a949646ae.js"]};/*]]>*/</script><script src="/polyfill-ed717a4fd71e6ab9d4db.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-fe46313b564a949646ae.js" async=""></script><script src="/d5d7a013bc6c1e2b6d7db819052c16d7efea5559-257226443b7dcc72fbb2.js" async=""></script><script src="/app-2c7963cebb708efe718f.js" async=""></script><script src="/styles-bc72ca78f9bad9fb1f45.js" async=""></script><script src="/framework-45f0bfe9f06e0e8da7d0.js" async=""></script><script src="/webpack-runtime-302c830d723193e48eb2.js" async=""></script></body></html>