<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.351cb4de4fb8fafa1978.css" id="gatsby-global-css">code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><meta name="generator" content="Gatsby 2.32.13"/><style data-styled="" data-styled-version="5.3.3">.iwJLgg{-webkit-text-decoration:none;text-decoration:none;color:rgba(0,0,0,0.8);}/*!sc*/
data-styled.g1[id="styled-link__StyledLink-sc-1pzq7s8-0"]{content:"iwJLgg,"}/*!sc*/
.eMJSpf{box-shadow:0 4px 12px 0 rgba(0,0,0,0.05);height:6rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}/*!sc*/
data-styled.g2[id="header__Container-sc-1hjyk8g-0"]{content:"eMJSpf,"}/*!sc*/
.jJfoNH{font-size:1.6rem;font-weight:800;-webkit-letter-spacing:0.1rem;-moz-letter-spacing:0.1rem;-ms-letter-spacing:0.1rem;letter-spacing:0.1rem;text-transform:uppercase;margin:0;}/*!sc*/
@media (max-width:36em){.jJfoNH{text-align:center;}}/*!sc*/
data-styled.g3[id="header__Title-sc-1hjyk8g-1"]{content:"jJfoNH,"}/*!sc*/
@font-face{font-family:system;font-style:normal;font-weight:300;src:local('.SFNSText-Light'),local('.HelveticaNeueDeskInterface-Light'),local('.LucidaGrandeUI'),local('Ubuntu Light'),local('Segoe UI Light'),local('Roboto-Light'),local('DroidSans'),local('Tahoma');}/*!sc*/
:root{font-size:10px;}/*!sc*/
body{font-family:'system';margin:0;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;color:rgba(0,0,0,0.8);min-height:100vh;position:relative;font-size:1.6rem;}/*!sc*/
h1,h2,h3,h4,h5,h6{font-family:sans-serif;}/*!sc*/
h2{font-size:2.5rem;}/*!sc*/
h3{font-size:2.4rem;}/*!sc*/
h4{font-size:1.6rem;}/*!sc*/
code{font-family:Menlo,Monaco,"Courier New",Courier,monospace;word-break:break-word;}/*!sc*/
pre code{word-break:normal;}/*!sc*/
:not(pre) > code[class*="language-"],pre[class*="language-text"]{background-color:transparent;color:inherit;font-size:medium;}/*!sc*/
data-styled.g4[id="sc-global-hvINus1"]{content:"sc-global-hvINus1,"}/*!sc*/
.doySxy{display:block;height:6rem;}/*!sc*/
data-styled.g5[id="layout__Footer-sc-wzore3-0"]{content:"doySxy,"}/*!sc*/
.hYEVc{width:60%;max-width:728px;margin:0 auto;}/*!sc*/
@media (max-width:48em){.hYEVc{width:80%;}}/*!sc*/
data-styled.g6[id="layout__Content-sc-wzore3-1"]{content:"hYEVc,"}/*!sc*/
.fkyYyS{margin-top:8rem;}/*!sc*/
@media (max-width:36em){.fkyYyS{margin-top:4rem;}}/*!sc*/
.fkyYyS p{line-height:1.5;}/*!sc*/
.fkyYyS blockquote{margin-left:0.25rem;font-size:1.6rem;color:inherit;font-style:italic;border-left:0.2rem solid rgb(0,0,0);padding-left:1rem;margin:1rem 0;}/*!sc*/
.fkyYyS pre{margin-bottom:2rem;}/*!sc*/
.fkyYyS h3{line-height:1.13;}/*!sc*/
.fkyYyS h2,.fkyYyS h3,.fkyYyS h4,.fkyYyS h5,.fkyYyS h6{margin:2rem 0 2rem;}/*!sc*/
.fkyYyS hr{border:0;border-top:0.1rem solid #ccc;display:block;height:1rem;padding:0;}/*!sc*/
data-styled.g18[id="post-styles__Container-sc-uvw59-0"]{content:"fkyYyS,"}/*!sc*/
@media (max-width:48em){.drQYUS{text-align:center;}}/*!sc*/
data-styled.g19[id="post-styles__Header-sc-uvw59-1"]{content:"drQYUS,"}/*!sc*/
.cCkgzF{margin-bottom:1rem;font-size:3rem;}/*!sc*/
data-styled.g20[id="post-styles__Title-sc-uvw59-2"]{content:"cCkgzF,"}/*!sc*/
.gmHquH{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;list-style:none;padding:0px;}/*!sc*/
data-styled.g21[id="post-styles__LinkList-sc-uvw59-3"]{content:"gmHquH,"}/*!sc*/
.beCzyQ{margin:1rem 0 5rem;}/*!sc*/
.beCzyQ .social-icon{display:inline-block;margin:0 0.5rem;cursor:pointer;}/*!sc*/
data-styled.g22[id="share__Container-sc-1hk3kno-0"]{content:"beCzyQ,"}/*!sc*/
.jiUAsV{font-size:1.4rem;color:rgb(0,0,0);}/*!sc*/
data-styled.g23[id="share___StyledP-sc-1hk3kno-1"]{content:"jiUAsV,"}/*!sc*/
.jyOtij{color:rgba(0,0,0,0.8);}/*!sc*/
data-styled.g24[id="blog-post___StyledSub-sc-1cxuom3-0"]{content:"jyOtij,"}/*!sc*/
.gjclbs{margin:5rem 0;}/*!sc*/
data-styled.g25[id="blog-post___StyledDiv-sc-1cxuom3-1"]{content:"gjclbs,"}/*!sc*/
</style><title data-react-helmet="true">AWS CodeDeploy를 이용한 자동 배포 시 환경변수 주입하기 + Spring Boot</title><meta data-react-helmet="true" name="description" content="해당 글은 AWS CodeDeploy 구축 과정을 설명하지 않습니다. 학교 캡스톤 프로젝트를 시작하게 되면서 서버를 띄우고 자동 배포 파이프라인 구축을 위해 Github Actions + AWS CodeDeploy…"/><meta data-react-helmet="true" property="og:title" content="AWS CodeDeploy를 이용한 자동 배포 시 환경변수 주입하기 + Spring Boot"/><meta data-react-helmet="true" property="og:description" content="해당 글은 AWS CodeDeploy 구축 과정을 설명하지 않습니다. 학교 캡스톤 프로젝트를 시작하게 되면서 서버를 띄우고 자동 배포 파이프라인 구축을 위해 Github Actions + AWS CodeDeploy…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" property="og:url" content="https://zooneon.dev"/><meta data-react-helmet="true" property="og:locale" content="ko_KR"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="zooneon"/><meta data-react-helmet="true" name="twitter:title" content="AWS CodeDeploy를 이용한 자동 배포 시 환경변수 주입하기 + Spring Boot"/><meta data-react-helmet="true" name="twitter:description" content="해당 글은 AWS CodeDeploy 구축 과정을 설명하지 않습니다. 학교 캡스톤 프로젝트를 시작하게 되면서 서버를 띄우고 자동 배포 파이프라인 구축을 위해 Github Actions + AWS CodeDeploy…"/><link rel="preconnect dns-prefetch" href="https://www.googletagmanager.com"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="icon" href="/favicon-32x32.png?v=5fa6e614f0c84651b75fe27d99928ac0" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/webpack-runtime-6995a3d0eb442c0384d1.js"/><link as="script" rel="preload" href="/framework-45f0bfe9f06e0e8da7d0.js"/><link as="script" rel="preload" href="/styles-bc72ca78f9bad9fb1f45.js"/><link as="script" rel="preload" href="/app-d23ecd4062e37e3a5f4a.js"/><link as="script" rel="preload" href="/d5d7a013bc6c1e2b6d7db819052c16d7efea5559-257226443b7dcc72fbb2.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-91ba287f12f3c353e51b.js"/><link as="fetch" rel="preload" href="/page-data/aws-codedeploy-environment-variables/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3649515864.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/983108779.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><noscript>Sorry! This site requires JavaScript to be enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav class="header__Container-sc-1hjyk8g-0 eMJSpf"><a class="styled-link__StyledLink-sc-1pzq7s8-0 iwJLgg" href="/"><h1 class="header__Title-sc-1hjyk8g-1 jJfoNH">zooneon.dev</h1></a></nav><div class="layout__Content-sc-wzore3-1 hYEVc"><article class="post-styles__Container-sc-uvw59-0 fkyYyS"><header class="post-styles__Header-sc-uvw59-1 drQYUS"><h1 class="post-styles__Title-sc-uvw59-2 cCkgzF">AWS CodeDeploy를 이용한 자동 배포 시 환경변수 주입하기 + Spring Boot</h1><sub class="blog-post___StyledSub-sc-1cxuom3-0 jyOtij"><span>Posted on <!-- -->April 11, 2022</span><span>  -  </span><span>11 min read</span></sub></header><div class="blog-post___StyledDiv-sc-1cxuom3-1 gjclbs"><blockquote>
<p>해당 글은 AWS CodeDeploy 구축 과정을 설명하지 않습니다.</p>
</blockquote>
<p>학교 캡스톤 프로젝트를 시작하게 되면서 서버를 띄우고 자동 배포 파이프라인 구축을 위해 Github Actions + AWS CodeDeploy를 사용하고 있었다.</p>
<p>둘 다 무료이고 리소스 사용량도 많지 않아 사정상 프리티어로(t2.micro) 개발 서버를 구축해야 하는 나에게는 좋은 선택지였다.</p>
<p>문제는 CodeDeploy를 통한 배포 과정에서 발생하였다.</p>
<p>분명 배포된 shell script를 실행하면 어플리케이션이 잘 동작하였는데 자동 배포 과정에서는 어플리케이션이 실행되지 않았다.</p>
<p>대체 뭐가 문제인지 모르겠어서 로그 파일을 만들고 확인해보니 application.yml 파일에 등록해 놓은 환경변수를 주입받지 못하고 있었다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># deploy.log</span>
java.lang.RuntimeException: Driver com.mysql.cj.jdbc.Driver claims to not accept jdbcUrl, <span class="token variable">${DATABASE_URL}</span>
	at com.zaxxer.hikari.util.DriverDataSource.<span class="token operator">&lt;</span>init<span class="token operator">></span><span class="token punctuation">(</span>DriverDataSource.java:110<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>HikariCP-4.0.3.jar<span class="token operator">!</span>/:na<span class="token punctuation">]</span>
	at com.zaxxer.hikari.pool.PoolBase.initializeDataSource<span class="token punctuation">(</span>PoolBase.java:331<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>HikariCP-4.0.3.jar<span class="token operator">!</span>/:na<span class="token punctuation">]</span>
	at com.zaxxer.hikari.pool.PoolBase.<span class="token operator">&lt;</span>init<span class="token operator">></span><span class="token punctuation">(</span>PoolBase.java:114<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>HikariCP-4.0.3.jar<span class="token operator">!</span>/:na<span class="token punctuation">]</span>
	at com.zaxxer.hikari.pool.HikariPool.<span class="token operator">&lt;</span>init<span class="token operator">></span><span class="token punctuation">(</span>HikariPool.java:108<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>HikariCP-4.0.3.jar<span class="token operator">!</span>/:na<span class="token punctuation">]</span>
	at com.zaxxer.hikari.HikariDataSource.getConnection<span class="token punctuation">(</span>HikariDataSource.java:112<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>HikariCP-4.0.3.jar<span class="token operator">!</span>/:na<span class="token punctuation">]</span>
	<span class="token punctuation">..</span>.</code></pre></div>
<p>개발 서버에서 사용할 데이터베이스 url과 username, password를 모두 공개해 놓으면 악의를 가진 사용자가 이를 활용해 데이터베이스를 마음대로 조작할 수 있기 때문에 환경변수로 처리하였다. </p>
<p><del>물론 그렇게 관심 가질만한 프로젝트는 아니지만 혹시나 해서</del></p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># application.yml</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token key atrule">activate</span><span class="token punctuation">:</span>
      <span class="token key atrule">on-profile</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>DATABASE_URL<span class="token punctuation">}</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>DATABASE_USERNAME<span class="token punctuation">}</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>DATABASE_PASSWORD<span class="token punctuation">}</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver</code></pre></div>
<p>이렇게 해두고 개발 서버에 환경변수를 등록해 놓았는데 CodeDeploy는 배포 과정에서 이 변수들을 주입받지 못하였다.</p>
<p>그래서 내가 직접 배포 스크립트를 실행하면 잘 동작하였지만 배포 과정에서는 동작하지 못하는 것이었다.</p>
<p>docker를 이용할 때는 compose파일에 변수를 넣어서 컨테이너를 띄울 때 주입받도록 하였는데(물론 이도 좋은 방법은 아닐 것이다.) 지금은 배포 과정에서 주입해줘야 했다.</p>
<p>그래서 그냥 배포 후 실행할 스크립트를 서버에 저장해두고(이렇게 하면 변수들을 public한 곳에서 숨긴 채로 배포할 수 있으니까?) CodeDeploy의 hook이 실행될 때 그 파일을 실행하도록 하였는데 정상적으로 작동하지 않았다.</p>
<p>이유를 찾아보니 CodeDeploy는 hook을 실행할 때 <code class="language-text">배포 ID</code>를 이름으로 하는 디렉토리 내부의 <code class="language-text">deployment-archive</code> 디렉토리를 location으로 하여 해당 디렉토리 내에서 파일을 찾는 것 같았다.</p>
<p>예를 들어 이런식으로</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">/opt/codedeploy-agent/deployment-root/9820b37d-a865-482e-b3d2-9f54ef466ab3/d-3D2Z6JP2G/deployment-archive</code></pre></div>
<p>그리고 location 속성은 절대경로도 먹히지 않는 것 같았다.</p>
<p>따라서 이렇게 <code class="language-text">appspec.yml</code> 파일을 작성하였다면 <code class="language-text">ScriptMissing</code> 에러가 발생하게 된다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># appspec.yml</span>
version: <span class="token number">0.0</span>
os: linux
files:
  - source: /
    destination: /home/ubuntu/app

hooks:
  ApplicationStart:
    - location: /home/ubuntu/deploy.sh
      timeout: <span class="token number">60</span></code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># ScriptMissing Error</span>
Script does not exist at specified location: /opt/codedeploy-agent/deployment-root/9820b37d-a865-482e-b3d2-9f54ef466ab3/d-3D2Z6JP2G/deployment-archive/home/ubuntu/deploy.sh</code></pre></div>
<p>따라서 어쩔 수 없이 프로젝트 디렉토리 내에 배포 스크립트를 작성하여 배포 시 같은 디렉토리에 위치하도록 하였다.(다른 방법이 있을 수도 있는데 내 한계였다..)</p>
<p>그리고 다시 환경변수를 어떻게 주입할지 열심히 찾아보았다.</p>
<h1>방법 1</h1>
<p>열심히 구글링을 하다가 찾은 건데 <code class="language-text">/etc/profile.d</code>에 CodeDeploy용 쉘스크립트를 작성하면 CodeDeploy가 환경변수를 읽을 수 있다는 것이었다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># /etc/profile.d/codedeploy.sh</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">DATABASE_URL</span><span class="token operator">=</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">DATABASE_USERNAME</span><span class="token operator">=</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">DATABASE_PASSWORD</span><span class="token operator">=</span></code></pre></div>
<p>하지만 deprecated 됐는지 나는 정상적으로 작동하지 않았다.(조금 예전 글이긴 했다.)</p>
<h1>방법 2</h1>
<p>다음으로 찾은 방법은 AWS의 <code class="language-text">Parameter Store</code>를 이용하는 방법이다.</p>
<p>간단하게 Parameter Store에 대해 알아보자</p>
<h2>Parameter Store란</h2>
<p>Parameter Store은 민감한 데이터를 외부에서 주입할 수 있도록 해주는 AWS 서비스인데 무료로 이용할 수 있다.</p>
<p>Parameter Store은 <code class="language-text">AWS System Manager → Parameter Store</code>에서 생성할 수 있다.</p>
<p>간단한 특징으로는</p>
<ul>
<li>key-value로 값을 저장</li>
<li>KMS(Key Management Service)를 이용한 암호화된 값 저장 가능</li>
<li>IAM을 이용하면 일부 사용자만 접근 가능</li>
<li>값에 대한 변경 이력 저장</li>
</ul>
<p>등이 있다.</p>
<h2>Parameter Store 등록</h2>
<p><img src="https://user-images.githubusercontent.com/59433441/162748673-5efb91a8-6f3e-4e3a-8010-cc7f4846cd76.png" alt="parameter store2"></p>
<p>파라미터는 이름, 타입, 값만 설정하면 쉽게 등록할 수 있다.</p>
<p>여기서 이름(<code class="language-text">Name</code>)은 슬래시(<code class="language-text">/</code>)를 사용한 계층 구조를 사용한다. </p>
<p><code class="language-text">ex) /config/zooneon_dev/DATABASE_PASSWORD</code></p>
<p>꼭 계층 구조를 사용할 필요는 없지만 파라미터 관리 용이 등의 이유로 이 방식이 권장된다.</p>
<p>중요한 데이터의 경우 보안 문자열(<code class="language-text">SecureString</code>)을 이용하여 암호화된 값을 저장할 수 있다.</p>
<p>보안 문자열 사용 시 Parameter Store에서는 요금이 청구되지 않지만 AWS Key Management Service 암호화 사용에 대한 요금이 적용된다.</p>
<p>파라미터를 등록하면 이름은 변경할 수 없고 값만 변경할 수 있으니 참고하자</p>
<h2>Parameter Store 사용</h2>
<p>파라미터를 등록했다면 어떻게 사용할까?</p>
<p>프레임워크마다 다르겠지만 나는 현재 프로젝트에서 Spring Boot를 사용하고 있기 때문에 Spring Boot에서 사용하는 방법에 대해 알아보았다.(다른 프레임워크들도 찾아보면 자료가 있을 것이다.)</p>
<p>사용한 버전은 Spring Boot 2.6.5, Gradle 7.4이다.</p>
<h3>의존성 설정</h3>
<p>나는 Spring Cloud Dependency가 없어 따로 추가하였다.</p>
<div class="gatsby-highlight" data-language="groovy"><pre class="language-groovy"><code class="language-groovy">dependencyManagement <span class="token punctuation">{</span>
    imports <span class="token punctuation">{</span>
        mavenBom <span class="token string">'io.awspring.cloud:spring-cloud-aws-dependencies:2.3.3'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>다음으로 dependency에 <code class="language-text">spring-cloud-starter-aws-parameter-store-config</code>을 추가해주면 된다.</p>
<div class="gatsby-highlight" data-language="groovy"><pre class="language-groovy"><code class="language-groovy">dependencies <span class="token punctuation">{</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-web'</span>
    testImplementation <span class="token string">'org.springframework.boot:spring-boot-starter-test'</span>
	<span class="token comment">//...</span>
    <span class="token comment">//parameter store</span>
    implementation <span class="token string">'io.awspring.cloud:spring-cloud-starter-aws-parameter-store-config'</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>yaml 파일 설정</h3>
<p>스프링 부트에 의존성을 추가했다면 이제 yaml 파일을 설정해줘야 한다.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># application.yml</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token key atrule">activate</span><span class="token punctuation">:</span>
      <span class="token key atrule">on-profile</span><span class="token punctuation">:</span> dev
		<span class="token comment"># aws-parameterstore: 추가</span>
    <span class="token key atrule">import</span><span class="token punctuation">:</span> <span class="token string">'aws-parameterstore:'</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>DATABASE_URL<span class="token punctuation">}</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>DATABASE_USERNAME<span class="token punctuation">}</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>DATABASE_PASSWORD<span class="token punctuation">}</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver

<span class="token comment"># 불러올 파라미터 설정</span>
<span class="token key atrule">aws</span><span class="token punctuation">:</span>
  <span class="token key atrule">paramstore</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> docswant</code></pre></div>
<p>기존 yaml 파일에 <code class="language-text">spring.config.import</code> 속성을 이용하여 <code class="language-text">aws-parameterstore:</code>를 추가하여 자동으로 파라미터를 불러오도록 설정한다.</p>
<p>또한 하단에 <code class="language-text">aws.paramstore</code> 속성을 이용하여 어떤 파라미터들을 불러올 지 설정할 수 있다.</p>
<h3>aws.paramstore 속성</h3>
<p><strong><code class="language-text">prefix</code></strong> </p>
<ul>
<li>파라미터의 prefix를 설정할 수 있다.</li>
<li>prefix는 슬래시(<code class="language-text">/</code>)로 시작해야 한다.</li>
<li>default : /config</li>
</ul>
<p><strong><code class="language-text">defaultContext</code></strong></p>
<ul>
<li>모든 서비스에서 공유되는 속성을 정의하는 컨텍스트 이름이다.</li>
<li>default : application</li>
</ul>
<p><strong><code class="language-text">profileSeparator</code></strong></p>
<ul>
<li>여러 환경에 배포할 수 있게 구분자를 사용할 수 있다.</li>
<li>profile은  <code class="language-text">spring.config.activate.on-profile</code> 속성에 설정된 값을 사용한다.</li>
<li>profile이 존재하지 않으면 사용되지 않는다.</li>
<li>dot(<code class="language-text">.</code>), dash(<code class="language-text">-</code>), forward slash(<code class="language-text">/</code>), backward slash(<code class="language-text">\</code>), underscore(<code class="language-text">_</code>)만 사용 가능하다.</li>
<li>default : underscore(<code class="language-text">_</code>)</li>
</ul>
<p><strong><code class="language-text">failFast</code></strong></p>
<ul>
<li>파라미터를 읽지 못했을 때 어떻게 할지 결정한다.</li>
<li>true이면 어플리케이션을 실행하지 못하도록 한다.</li>
<li>default : true</li>
</ul>
<p><strong><code class="language-text">name</code></strong></p>
<ul>
<li>파라미터의 식별자 어플리케이션 이름이다.</li>
<li>파라미터를 어떤 어플리케이션에 적용할 건지 지정할 수 있다.</li>
<li>값을 지정하지 않으면 <code class="language-text">spring.application.name</code> 속성값을 참조한다.</li>
<li>위 속성마저 존재하지 않으면 default 값을 사용한다.</li>
<li>default : application</li>
</ul>
<p><strong><code class="language-text">enabled</code></strong></p>
<ul>
<li>Parameter Store를 사용할지 선택한다.</li>
<li>default : true</li>
</ul>
<h3>IAM 역할 등록</h3>
<p>yaml 파일 설정을 완료했다면 Parameter Store에 접근할 수 있는 권한을 등록해야 한다.</p>
<p>기존에 생성한 EC2 IAM 역할에 <code class="language-text">AmazonSSMReadOnlyAccess</code> 권한을 추가한다.</p>
<p><img src="https://user-images.githubusercontent.com/59433441/162745927-a99a0fcc-30ea-42b7-9a28-1bff669a7754.png" alt="iam2"></p>
<p>IAM을 등록한 후에 다시 배포를 하면 성공적으로 어플리케이션이 실행될 것이다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># deploy.log</span>
<span class="token builtin class-name">.</span>   ____          _            __ _ _
 /<span class="token punctuation">\</span><span class="token punctuation">\</span> / ___<span class="token string">'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '</span>_ <span class="token operator">|</span> <span class="token string">'_| | '</span>_ <span class="token punctuation">\</span>/ _` <span class="token operator">|</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span>
 <span class="token punctuation">\</span><span class="token punctuation">\</span>/  ___<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token operator">|</span>_<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">||</span> <span class="token punctuation">(</span>_<span class="token operator">|</span> <span class="token operator">|</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token string">'  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v2.6.5)
...
...
...
2022-04-11 09:36:45.514  INFO 819 --- [           main] o.s.s.web.DefaultSecurityFilterChain     : Will not secure any request
2022-04-11 09:36:46.536  INFO 819 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path '</span>'
<span class="token number">2022</span>-04-11 09:36:46.564  INFO <span class="token number">819</span> --- <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> s.capstone.docswant.DocswantApplication  <span class="token builtin class-name">:</span> Started DocswantApplication <span class="token keyword">in</span> <span class="token number">12.712</span> seconds <span class="token punctuation">(</span>JVM running <span class="token keyword">for</span> <span class="token number">14.137</span><span class="token punctuation">)</span></code></pre></div>
<h1>마무리</h1>
<p>거의 Parameter Store 글에 가까운 것 같지만</p>
<p>그래도 내가 겪은 trouble shooting 과정을 겪는 사람들도 분명 있을 것이라 생각하기 때문에</p>
<p>이 글을 보고 솔루션을 찾는데 조금이나마 도움이 되었으면 좋겠다.</p>
<hr>
<h3>참고</h3>
<ul>
<li><a href="https://godngu.github.io/aws/codedeploy-envrionment-variable">https://godngu.github.io/aws/codedeploy-envrionment-variable</a></li>
<li><a href="https://docs.awspring.io/spring-cloud-aws/docs/2.3.0/reference/html/index.html#integrating-your-spring-cloud-application-with-the-aws-parameter-store">https://docs.awspring.io/spring-cloud-aws/docs/2.3.0/reference/html/index.html#integrating-your-spring-cloud-application-with-the-aws-parameter-store</a></li>
</ul></div><ul class="post-styles__LinkList-sc-uvw59-3 gmHquH"><li><a rel="prev" class="styled-link__StyledLink-sc-1pzq7s8-0 iwJLgg" href="/spring-boot-profile/">← <!-- -->Spring Boot profile 설정하기</a></li><li></li></ul><div class="comments-wrapper"><div>Loading script...</div><div></div></div><div class="share__Container-sc-1hk3kno-0 beCzyQ"><p class="share___StyledP-sc-1hk3kno-1 jiUAsV">Share if you liked it:</p></div></article></div><footer class="layout__Footer-sc-wzore3-0 doySxy"></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-PB788GF0S1"></script><script>
        
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
        </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/aws-codedeploy-environment-variables/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-ed717a4fd71e6ab9d4db.js"],"app":["/app-d23ecd4062e37e3a5f4a.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-16703ee5599528db9f93.js"],"component---src-pages-404-js":["/component---src-pages-404-js-9ead8f60164dc266ad59.js"],"component---src-pages-index-js":["/component---src-pages-index-js-911b6742c5b371483563.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-91ba287f12f3c353e51b.js"]};/*]]>*/</script><script src="/polyfill-ed717a4fd71e6ab9d4db.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-91ba287f12f3c353e51b.js" async=""></script><script src="/d5d7a013bc6c1e2b6d7db819052c16d7efea5559-257226443b7dcc72fbb2.js" async=""></script><script src="/app-d23ecd4062e37e3a5f4a.js" async=""></script><script src="/styles-bc72ca78f9bad9fb1f45.js" async=""></script><script src="/framework-45f0bfe9f06e0e8da7d0.js" async=""></script><script src="/webpack-runtime-6995a3d0eb442c0384d1.js" async=""></script></body></html>